# SPEC-KIS-001: KIS OpenAPI 인증 시스템 - 인수 기준

## TAG BLOCK

```
TAG: SPEC-KIS-001
TITLE: KIS OpenAPI 인증 시스템
STATUS: Planned
PRIORITY: High
DOMAIN: KIS (Korea Investment & Securities OpenAPI)
```

## 개요

본 문서는 KIS OpenAPI 인증 시스템의 인수 기준(Acceptance Criteria)을 정의합니다. Given-When-Then 형식의 시나리오 기반 테스트를 통해 모든 요구사항이 충족되었는지 검증합니다.

## 테스트 시나리오

### 시나리오 1: 초기 인증 토큰 발급

**Given**: 사용자가 KIS OpenAPI 앱 키와 시크릿 키를 보유하고 있음
**When**: 사용자가 KIS 인증을 초기화하면
**Then**: 시스템은 KIS OAuth 2.0 엔드포인트에 인증 요청을 전송해야 한다

---

**Given**: KIS API가 유효한 인증 정보를 수신했음
**When**: 인증 요청이 성공하면
**Then**: 액세스 토큰, 리프레시 토큰, 만료 시간이 포함된 응답을 반환해야 한다

---

**Given**: 발급받은 액세스 토큰과 리프레시 토큰이 있음
**When**: 토큰을 데이터베이스에 저장하면
**Then**: 토큰은 AES-256으로 암호화되어 PostgreSQL kis_tokens 테이블에 저장되어야 한다

---

**Given**: 저장된 토큰이 있음
**When**: 저장된 토큰을 조회하면
**Then**: 복호화된 원본 토큰이 반환되어야 한다

### 시나리오 2: 자동 토큰 갱신

**Given**: 액세스 토큰이 만료되기 5분 전임
**When**: 토큰 갱신 스케줄러가 실행되면
**Then**: 시스템은 리프레시 토큰을 사용하여 자동으로 액세스 토큰을 갱신해야 한다

---

**Given**: 갱신된 액세스 토큰을 받음
**When**: 새 토큰을 저장하면
**Then**: 데이터베이스의 토큰 정보가 갱신되어야 하고, updated_at 타임스탬프가 현재 시간으로 업데이트되어야 한다

---

**Given**: API 요청 중에 401 Unauthorized 응답을 받음
**When**: 인증 미들웨어가 401을 감지하면
**Then**: 토큰을 갱신하고 원래 요청을 재시도해야 한다

---

**Given**: 토큰 갱신이 성공함
**When**: 재시도된 요청을 전송하면
**Then**: 새 토큰으로 요청이 성공해야 한다

### 시나리오 3: API 요청 인증 헤더 추가

**Given**: 유효한 액세스 토큰이 있음
**When**: KIS API 엔드포인트에 요청을 전송하면
**Then**: 요청 헤더에 `Authorization: Bearer {access_token}`이 포함되어야 한다

---

**Given**: KIS API에 요청을 보냄
**When**: 요청 헤더를 확인하면
**Then**: Content-Type, 기타 KIS 요구 필수 헤더가 모두 포함되어야 한다

---

**Given**: 인증되지 않은 API 요청임
**When**: 인증 미들웨어가 요청을 가로채면
**Then**: 자동으로 인증 헤더를 추가하고 요청을 전달해야 한다

### 시나리오 4: API 로깅

**Given**: KIS API 요청을 전송함
**When**: 요청이 전송되면
**Then**: 요청 URL, 메서드, 타임스탬프, 요청 ID가 kis_api_logs 테이블에 기록되어야 한다

---

**Given**: API 응답을 받음
**When**: 응답 로그를 기록하면
**Then**: 상태 코드, 응답 시간(latency), 성공 여부가 기록되어야 한다

---

**Given**: 로그에 민감한 정보가 포함된 요청임
**When**: 로그를 기록하면
**Then**: 시크릿 키, 리프레시 토큰 등 민감 정보는 `***MASKED***`로 마스킹되어야 한다

---

**Given**: 여러 API 요청이 수행됨
**When**: 로그를 쿼리하면
**Then**: 요청 ID를 통해 요청-응답 쌍을 추적할 수 있어야 한다

### 시나리오 5: 재시도 정책

**Given**: API 요청이 네트워크 오류(ECONNRESET)로 실패함
**When**: 재시도 로직이 실행되면
**Then**: 1초 후 첫 번째 재시도를 수행해야 한다

---

**Given**: 첫 번째 재시도가 실패함
**When**: 두 번째 재시도를 수행하면
**Then**: 2초 후(지수 백오프) 재시도해야 한다

---

**Given**: API 요청이 429 Too Many Requests 응답을 받음
**When**: 429 응답을 처리하면
**Then**: Retry-After 헤더가 있으면 그 시간만큼 대기하고, 없으면 60초 후 재시도해야 한다

---

**Given**: API 요청이 5회 연속 실패함
**When**: 최대 재시도 횟수에 도달하면
**Then**: 재시도를 중단하고 상세 에러 메시지를 반환해야 한다

---

**Given**: 최대 재시도 실패가 발생함
**When**: 실패를 기록하면
**Then**: 로그에 실패 사유를 기록하고 관리자에게 알림을 발송해야 한다

### 시나리오 6: 속도 제한 준수

**Given**: KIS API 속도 제한이 분당 100회임
**When**: 1분 내에 100회의 요청을 수행하면
**Then**: 101번째 요청은 큐에 대기시키거나 지연시켜야 한다

---

**Given**: 속도 제한에 근접함
**When**: 요청 속도를 모니터링하면
**Then**: 속도 제한에 도달하기 전에 경고를 로그에 기록해야 한다

### 시나리오 7: 다중 계정 지원 (선택사항)

**Given**: 사용자가 첫 번째 KIS 계정을 연동함
**When**: 두 번째 KIS 계정을 추가하면
**Then**: 두 계정의 토큰이 독립적으로 저장되어야 한다

---

**Given**: 두 개의 KIS 계정이 연동됨
**When**: 사용자가 계정을 전환하면
**Then**: API 요청이 선택된 계정의 토큰을 사용해야 한다

---

**Given**: 사용자가 KIS 계정 연동을 해제함
**When**: 연동 해제를 요청하면
**Then**: 해당 계정의 토큰이 데이터베이스에서 안전하게 삭제되어야 한다

## 엣지 케이스

### 엣지 케이스 1: 토큰 갱신 실패

**Given**: 리프레시 토큰도 만료됨
**When**: 토큰 갱신을 시도하면
**Then**: 사용자에게 재인증이 필요하다는 메시지를 표시해야 한다

---

**Given**: 토큰 갱신 중 KIS API가 다운됨
**When**: 갱신 요청이 실패하면
**Then**: 로그에 실패를 기록하고, 다음 스케줄 시점에 재시도해야 한다

### 엣지 케이스 2: 로깅 오류

**Given**: API 요청이 성공함
**When**: 로그 기록이 실패하면
**Then**: API 응답은 정상적으로 반환되어야 하고, 로그 오류는 별도로 기록해야 한다

---

**Given**: 로그 데이터베이스 연결이 끊김
**When**: 로그를 기록하려고 하면
**Then**: API 요청은 차단되지 않고, 로그는 메모리에 버퍼링되어야 한다

### 엣지 케이스 3: 암호화 실패

**Given**: 토큰 암호화 중 오류 발생
**When**: 암호화가 실패하면
**Then**: 토큰을 저장하지 않고 사용자에게 보안 경고를 표시해야 한다

---

**Given**: 암호화 키가 환경 변수에 없음
**When**: 애플리케이션이 시작되면
**Then**: 시작을 거부하고 `KIS_ENCRYPTION_KEY` 환경 변수 설정을 요구해야 한다

### 엣지 케이스 4: 동시 요청 경쟁 조건

**Given**: 두 개의 API 요청이 동시에 만료된 토큰을 사용함
**When**: 두 요청이 모두 401을 받고 토큰 갱신을 시도하면
**Then**: 첫 번째 요청만 갱신을 수행하고, 두 번째 요청은 갱신된 토큰을 재사용해야 한다 (Race Condition 방지)

## 성공 기준 (Definition of Done)

### 기능적 완료 기준

- [ ] **인증**: KIS OpenAPI OAuth 2.0 인증이 정상적으로 작동함
- [ ] **토큰 관리**: 액세스 토큰 발급, 갱신, 저장, 삭제가 모두 작동함
- [ ] **자동 갱신**: 토큰 만료 5분 전에 자동 갱신이 수행됨
- [ ] **인증 헤더**: 모든 API 요청에 자동으로 Authorization 헤더가 추가됨
- [ ] **재시도**: 실패 요청이 지수 백오프로 재시도됨
- [ ] **로깅**: 모든 API 요청/응답이 구조화된 로그로 기록됨
- [ ] **마스킹**: 민감 정보가 로그에서 마스킹됨

### 품질 기준 (TRUST 5)

#### Test-first (테스트 우선)
- [ ] 모든 시나리오가 Given-When-Then 형식의 테스트로 작성됨
- [ ] 테스트 커버리지가 85% 이상임
- [ ] 모든 테스트가 통과함

#### Readable (가독성)
- [ ] 코드가 ESLint 규칙을 통과함
- [ ] 함수와 변수명이 명확함
- [ ] 복잡한 로직에 주석이 포함됨

#### Unified (통일성)
- [ ] 코드가 Prettier로 포맷팅됨
- [ ] TypeScript 타입이 명확히 정의됨
- [ ] 일관된 에러 처리 패턴 사용

#### Secured (보안)
- [ ] 모든 토큰이 AES-256으로 암호화됨
- [ ] 로그에 민감 정보가 포함되지 않음
- [ ] OWASP Top 10 보안 취약점이 없음
- [ ] 환경 변수로 암호화 키를 관리함

#### Trackable (추적 가능성)
- [ ] 모든 API 요청에 고유 요청 ID가 있음
- [ ] 로그를 통해 요청 추적이 가능함
- [ ] Git 커밋 메시지가 명확함

### 성능 기준

- [ ] **응답 시간**: API 요청의 P95 응답 시간이 2초 미만임
- [ ] **토큰 갱신**: 토큰 갱신이 1초 이내에 완료됨
- [ ] **동시성**: 100개의 동시 요청을 처리할 수 있음

### 보안 기준

- [ ] **암호화**: 모든 인증 정보가 AES-256-GCM으로 암호화됨
- [ ] **HTTPS**: 모든 API 통신이 HTTPS를 사용함
- [ ] **로깅 보안**: 민감 정보(시크릿 키, 리프레시 토큰)가 로그에 포함되지 않음
- [ ] **키 관리**: 암호화 키가 환경 변수로 안전하게 관리됨

## 검증 방법

### 자동화된 테스트

1. **단위 테스트**: Vitest 또는 Jest로 각 모듈 테스트
2. **통합 테스트**: KIS API 모킹으로 전체 흐름 테스트
3. **E2E 테스트**: Playwright로 실제 사용자 시나리오 테스트

### 수동 테스트

1. **KIS 개발 환경**: KIS OpenAPI 개발 환경에서 실제 인증 테스트
2. **모니터링 대시보드**: 로그 및 메트릭 확인

### 보안 감사

1. **코드 리뷰**: Security 전문가에 의한 코드 리뷰
2. **취약점 스캔**: OWASP ZAP 또는 similar 도구로 스캔
3. ** penetration Testing**: 선택사항, 전문 펜트레스팅

## 승인 절차

1. **개발 완료**: 모든 기능이 구현되고 테스트 통과
2. **코드 리뷰**: Backend 및 Security 전문가 리뷰
3. **QA 테스트**: QA 팀에 의한 테스트 수행
4. **보안 감사**: Security 취약점 점검
5. **프로덕션 배포**: 스테이징 환경에서 최종 검증 후 배포
